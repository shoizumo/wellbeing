<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>シェーダープログラミング：球オブジェクト</title>
<script src="three.js"></script>      <!-- Three.js用ライブラリ -->
<script src="TrackballControls.js"></script> <!-- トラックボール用ライブラリ -->
<style>
*{padding:0px; margin:0px}
div#canvas-frame{
	width: 500px;  /* 横幅 */
	height: 500px; /* 縦幅 */
	overflow:hidden;
}
</style>
<script>
	////////////////////////////////////////////////////////////////////
	// windowイベントの定義
	////////////////////////////////////////////////////////////////////
	window.addEventListener("load", function () {
		resizeTo(516, 539);
		threeStart(); //Three.jsのスタート関数の実行
	});
	////////////////////////////////////////////////////////////////////
	// Three.jsスタート関数の定義
	////////////////////////////////////////////////////////////////////
	function threeStart() {
		initThree();  //Three.js初期化関数の実行
		initLight();  //光源初期化関数の実行
		initObject(); //オブジェクト初期化関数の実行
		initCamera(); //カメラ初期化関数の実行
		loop();       //無限ループ関数の実行
	}
	////////////////////////////////////////////////////////////////////
	// Three.js初期化関数の定義
	////////////////////////////////////////////////////////////////////
	//グローバル変数の宣言
	var renderer,    //レンダラーオブジェクト
	    scene,       //シーンオブジェクト
	    canvasFrame; //キャンバスフレームのDOM要素
	function initThree() {
		//キャンバスフレームDOM要素の取得
		canvasFrame = document.getElementById('canvas-frame');
		//レンダラーオブジェクトの生成
		renderer = new THREE.WebGLRenderer({ antialias: true });
		//renderer = new THREE.CanvasRenderer();//<-----------------------------------------------------（canvasレンダラー）

		if (!renderer) alert('Three.js の初期化に失敗しました');
		//レンダラーのサイズの設定
		renderer.setSize(canvasFrame.clientWidth, canvasFrame.clientHeight);
		//キャンバスフレームDOM要素にcanvas要素を追加
		canvasFrame.appendChild(renderer.domElement);

		//レンダラークリアーカラーの設定
		renderer.setClearColor(0x000000, 1.0);

		//シーンオブジェクトの生成
		scene = new THREE.Scene();
	}
	////////////////////////////////////////////////////////////////////
	// カメラ初期化関数の定義
	////////////////////////////////////////////////////////////////////
	//グローバル変数の宣言
	var camera;    //カメラオブジェクト
	function initCamera() {
		//カメラオブジェクトの生成
		camera = new THREE.PerspectiveCamera(45, canvasFrame.clientWidth / canvasFrame.clientHeight, 1, 10000);
		//カメラの位置の設定
		camera.position.set( 80, 80, 80);
		//カメラの上ベクトルの設定
		camera.up.set(0, 1, 0);
		//カメラの中心位置ベクトルの設定
		camera.lookAt({ x: 0, y: 0, z: 0 }); //トラックボール利用時は自動的に無効

		//トラックボールオブジェクトの宣言
		trackball = new THREE.TrackballControls(camera, canvasFrame);

		//トラックボール動作範囲のサイズとオフセットの設定
		trackball.screen.width = canvasFrame.clientWidth;                        //横幅
		trackball.screen.height = canvasFrame.clientHeight;                      //縦幅
		trackball.screen.offsetLeft = canvasFrame.getBoundingClientRect().left;  //左オフセット
		trackball.screen.offsetTop = canvasFrame.getBoundingClientRect().top;    //右オフセット

		//トラックボールの回転無効化と回転速度の設定
		trackball.noRotate = false;
		trackball.rotateSpeed = 4.0;

		//トラックボールの拡大無効化と拡大速度の設定
		trackball.noZoom = false;
		trackball.zoomSpeed = 4.0;

		//トラックボールのカメラ中心移動の無効化と中心速度の設定
		trackball.noPan = false;
		trackball.panSpeed = 1.0;
		trackball.target = new THREE.Vector3(0, 0, 0);

		//トラックボールのスタティックムーブの有効化
		trackball.staticMoving = true;
		//トラックボールのダイナミックムーブ時の減衰定数
		trackball.dynamicDampingFactor = 0.3;
	}
	////////////////////////////////////////////////////////////////////
	// 光源初期化関数の定義
	////////////////////////////////////////////////////////////////////
	//グローバル変数の宣言
	var directionalLight,  //平行光源オブジェクト
	    ambientLight;      //環境光オブジェクト
	function initLight() {
		//平行光源オブジェクトの生成
		directionalLight = new THREE.DirectionalLight(0xDDDDDD, 1.0, 0);
		//平行光源オブジェクトの位置の設定
		directionalLight.position.set(50, 20, 100);
		//平行光源オブジェクトのシーンへの追加
		scene.add(directionalLight);

		//環境光オブジェクトの生成
		ambientLight = new THREE.AmbientLight(0x222222);
		//環境光オブジェクトのシーンへの追加
		scene.add(ambientLight);
	}
	////////////////////////////////////////////////////////////////////
	// オブジェクト初期化関数の定義
	////////////////////////////////////////////////////////////////////
	//グローバル変数の宣言
	var axis; //軸オブジェクト
	var sphere; //球オブジェクト
	function initObject() {
		//軸オブジェクトの生成
		axis = new THREE.AxisHelper(100);
		//軸オブジェクトのシーンへの追加
		scene.add(axis);
		//軸オブジェクトの位置座標を設定
		axis.position.set(0, 0, 0);

		//半径
		var R = 50;

		//球形バッファーオブジェクト
		var buffergeometry = new THREE.SphereBufferGeometry( R, 100, 50 ) ;
		var vertices = buffergeometry.attributes.position.array;

		//変更量
		var displacement = new THREE.Float32Attribute( vertices.length * 3, 3 );
		for ( var i = 0; i < vertices.length / 3; i++ ) {

			displacement.setXYZ( i , 
				R / 10 * ( 0.5 - Math.random() ),
				R / 10 * ( 0.5 - Math.random() ),
				R / 10 * ( 0.5 - Math.random() )
			);
		}
		//アトリビュート変数を登録
		buffergeometry.addAttribute( 'displacement', displacement );

		//頂点色
		var color = new THREE.Float32Attribute( vertices.length * 4, 4 );
		for( var i = 0; i < vertices.length / 3 ; i ++ ) {
			color.setXYZW( i,
				vertices[ 3 * i     ] / R,
				vertices[ 3 * i + 1 ] / R,
				vertices[ 3 * i + 2 ] / R,
				0.3
			);
		}
		//アトリビュート変数を登録
		buffergeometry.addAttribute( 'color', color );

		//シェーダー材質オブジェクトの生成
		var shaderMaterial = new THREE.ShaderMaterial( {
			uniforms: {
				amplitude: { type: "f", value: 0.0 }
			},
			vertexShader:   document.getElementById( 'vertexShader' ).textContent,
			fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
			blending:       THREE.AdditiveBlending,
			depthTest:    false,
			transparent : true
		});

		//球オブジェクトの生成
		sphere = new THREE.Line( buffergeometry, shaderMaterial );
		scene.add( sphere );
	}

	////////////////////////////////////////////////////////////////////
	// 無限ループ関数の定義
	////////////////////////////////////////////////////////////////////
	//グローバル変数の宣言
	var step = 0; //ステップ数
	function loop() {
		//トラックボールによるカメラオブジェクトのプロパティの更新
		trackball.update();

		//ステップ数のインクリメント
		step++;

		sphere.material.uniforms.amplitude.value = Math.sin( step / 60 );

		//レンダリング
		renderer.render(scene, camera);

		//「loop()」関数の呼び出し
		requestAnimationFrame(loop);
	}
</script>
<!--------------------------------------------------------------------------------------
	シェーダーの定義
 ---------------------------------------------------------------------------------------->
<script id="vertexShader" type="x-shader/x-vertex">
//uniform型変数の受け取り
uniform float amplitude;

//attribute型変数（頂点データ）の宣言
attribute vec3 displacement;
attribute vec4 color;

//フラグメントシェーダーへ転送する変数
varying vec4 vColor;

void main() {

	//頂点色はそのままフラグメントシェーダーへ転送
	vColor = color;

	//頂点座標を更新
	vec3 newPosition = position + amplitude * displacement;

	//クリップ座標系の頂点座標
	gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );

}
</script>
<script id="fragmentShader" type="x-shader/x-fragment">
//バーテックスシェーダーから転送された変数
varying vec4 vColor;

void main() {

	gl_FragColor = vColor;

}
</script>
</head>
<body>
	<div id="canvas-frame"></div><!-- canvas要素を配置するdiv要素 -->
</body>
</html>